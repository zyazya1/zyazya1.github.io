# 1.4.1.3 以太网做法

1.基础设置

按1.4.1.1中方法，设置4个场景，scene 1~scene 4

scene 1：CPU形状及颜色

scene 2：集成电路形状及颜色

scene 3：电容形状及颜色

scene 4：三极管形状及颜色

IP地址192.168.125.4（可更改，须与程序一致）

端口号2000（可更改，须与程序一致）

以太网做法中，需要将ccd主机与交换机用网线相连。

2.程序编写

（1）变量定义：

```
var socketdev s2;用于与ccd通信的套接字
pers string sc{4}:=["scene 1","scene 2","scene 3","scene 4"];四个场景，注意scene和数字之间有一个空格
var bool ok;用于判断strtoval是否成功
var string cjg;存放strpart截取结果
var string sr;存放ccd反馈结果
var num d;反馈芯片的类型
```

（2）检测程序

以下为func写法与proc写法的参考，程序不唯一，可以继续优化。

```
proc main()
	...
	for i from 1 to 4 do
		for j from 1 to k{i} do
			...
			yz{i,j}:=ccd(i);注意这里是小括号
			...
            endfor
	endfor
	...
endproc
func num ccd(num a)
	socketclose s2;先关闭套接字，防止上一次执行后未关闭
	socketcreate s2;创建套接字
	socketconnect s2,"192.168.125.4",2000;向IP地址及端口号对应设备发起连接
	socketsend s2\str:=sc{a};切换场景
	movel dw{5},v1000,z50,tool0;
	movel dw{5},v1000,fine,tool0;移动至ccd上方
	socketsend s2\str:="m";拍照
	w 0.2;等待一段时间，确保数据完整接收
	socketreceive s2\str:=sr;将接收到的数据赋值给字符串变量sr
	cjg:=strpart(sr,7,2);将sr从第7位开始往后截取2位数据并赋值给cjg，先截取形状检测结果
	ok:=strtoval(cjg,d);将字符串cjg转为数字并赋值给num型变量d
	if d=1 then如果形状为1（OK），则判断颜色
		cjg:=strpart(sr,10,2);截取颜色检测结果
		ok:=strtoval(cjg,d);
		if d=-1 d:=2;如果颜色为-1（NG），则给该芯片状态赋值为2
	else
		d:=3;若形状检测结果不为1，则判断为掺杂，赋值为3
	endif
	return d;返回变量d的值
endfunc
```

```
proc main()
	...
	for i from 1 to 4 do
		for j from 1 to k{i} do
			...
			ccd i;
			yz{i,j}:=d;
			...
            endfor
	endfor
	...
endproc
proc ccd(num a)
	socketclose s2;
	socketcreate s2;
	socketconnect s2,"192.168.125.4",2000;
	socketsend s2\str:=sc{a};
	movel dw{5},v1000,z50,tool0;
	movel dw{5},v1000,fine,tool0;
	socketsend s2\str:="m";
	w 0.2;
	socketreceive s2\str:=sr;
	cjg:=strpart(sr,7,2);
	ok:=strtoval(cjg,d);
	if d=1 then
		cjg:=strpart(sr,10,2);
		ok:=strtoval(cjg,d);
		if d=-1 d:=2;
	else
		d:=3;
	endif
endproc
```

